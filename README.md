README.md - 2017-Apr-05 - Kevin Castner

emed contains python scripts to digest event data from EM7 DB instances and create documentation.

The requirements to run these scripts are as follows:
	1) a mysql/mariadb instance (5.5 or higher)
		a) yum -y install mariadb-server mariadb
		b) systemctl enable mariadb
		c) systemctl status mariadb
	2) a login for mysql sufficient to create/drop databases
	3) ensure the following pacakages are installed via package manager
	    a) python-devel
		b) mariadb-devel
		c) mysql-connector-python
		d) gcc
	4) python 2.7 or higher with the following modules (and any second order dependencies)
		a) argparse (1.3.0)
		b) et-xmlfile (1.0.1)
		c) lxml (3.4.4)
		d) msgpack-python (0.4.6)
		e) mysql-connector-python (2.1.4)
		f) MySQL-python (1.2.3rc1)
		g) opc-diag (1.0.0)
		h) openpyxl (2.4.5)
		i) pycurl (7.19.0)
		j) python-docx (0.8.5)
		k) PyYAML (3.11)

File descriptions:
emed-blgen.py - creates an xlsx document intended for client distribution that details event messages and thresholds.  This is referred to as the "baseline" document.

emed-sopgen.py - creates an xlsx document intended for use by the GCC/CC/NOC the details event messages, incident priorities, and initial triage procedures.  This is referred to as the SOP document.

emed-db-populate-events.py - reads an xlsx document and populates the emed database with data to generate the documentation.

setup-emed.sql - sources additional *.sql files in order to correctly setup the emed database.

emed-schema.sql - contains sql statements for emed schema setup

emed-sheets-data.sql - contains sql statements that link dynamic apps to tabs in the output spreadsheets.  This is where all the business logic resides.

createWS.py - source file for python support functions
loadWS.py

EVTM.crd - a json formatted file containing the login credentials for the mysql database.  Should be chmod 600 or 640.

README.md - This file

Operation:
From a cold VM where this has never been run before and assuming a linux OS

a) install python 2.7
b) use pip to install python modules as listed above
b) install mariadb 10.0 or mysql 5.5
c) create a user (eventmgt in this example) and assign password and privileges
	i) CREATE USER 'eventmgt'@'localhost' IDENTIFIED BY 'password';
	ii) GRANT ALL PRIVILEGES ON *.* TO 'eventmgt'@'localhost';
	
d) Edit EVTM.crd "emed" entry and set this user's name and password.
e) Setup the emed database with the following command
	i)mysql -u root -p < setup-emed.sql && ./emed-db-populate
f) run emed-blgen.py or emed-sopgen.py as required to create the output documentation.

Additonal Notes:
1) The files Events-App_*.xlsx and Evernts-Trap_*.xlsx are currently hard coded into the emed-db-populate.py script.
	a) To add additional events this file needs to be added to directly or the populate script
       needs to be updated to loop through a list.

	b) The Events-App_*xlsx file is generated by running the following sql against the master db of an EM7 DB stack.

		use master;

		select da.name as AppName, ename as EventName, aa.message as AlertMessage,
			ath.t_value as ThresholdValue, ath.t_unit as ThresholdUnit,
			eseverity as EventSeverity,
			id as EventID, emessage as EventMessage,
			aa.name as AlertName, ath.name as ThresholdName,
			event_guid as EventGUID, ev.app_guid as AppGUID,
			aa.alert_guid as AlertGUID, ath.thresh_guid as ThreshGUID
			,ath.thresh_id as ThreshLocalID, aa.formula as formula
		from policies_events as ev
		join dynamic_app as da on ev.app_guid = da.app_guid
		join dynamic_app_alerts as aa on ev.Xoid = aa.alert_id
		join dynamic_app_thresholds as ath on aa.app_guid = ath.app_guid
		where eseverity != 0
			-- and ev.app_guid is not NULL
			-- where aa.alert_id = 1279
			and aa.formula like CONCAT('%threshold%(%t\_', ath.thresh_id,'%)%')
		order by AppName, EventGUID

				i) put this query in a file on the EM7 DB and run the script as follows
					mysql -u root -p master < sqlquery.sql | sed -e 's/^M//g' > AllEvents.csv
				ii) import the csv file into Excel and save as an xlsx file to import into emed.

	c) Events-Trap_*.xlsx is generated by using the following SQL against the master db of an EM7 DB stack

		use master;
		select ename as EventName
			,eseverity as EventSeverity
			,id as EventID
			,emessage as EventMessage
			,event_guid as EventGUID
			,ppguid as PowerPackGUID
			from policies_events as ev
			where esource = (select esource from master.definitions_event_sources where descr = 'Trap')
			and ppguid is not null
			order by EventName, EventSeverity desc;
	
	d) Events-Internal_*.xlsx is generated with the following query against any production stack
		use master;
		select ename as EventName
			,eseverity as EventSeverity
			,definitions_internal_messages.msg_txt as EventMessage
			,event_guid as EventGUID
			,ppguid as PowerpackGUID
			from policies_events
			RIGHT OUTER JOIN definitions_internal_messages on msg_id = Xoid
			where esource = (select esource from master.definitions_event_sources where descr = 'Internal')
			and eseverity != 0
			ORDER BY ename
			;
		Note: The Events-Trap and Events-Internal currently look very similar but the messages are stored differently
		This might be able to be merged into a single table in EMED at some point.